## Миграции схем: alembic

alembic основывается на SQLAlchemy, поэтому применяется только в паре с данной ORM

Версионирование изменений схемы БД

Правила:
 - При работе с БД мы ТОЛЬКО добавляем новые колонки (старая не нужна - забываем,
нужно поменять имя - не меняем ничего)
 - Такая же петрушка и с API, ТОЛЬКО ДОБАВЛЯЕМ, а старое НЕ удаляем, т.к. сторонние
сервисы могут из-за этого нагнуться
 - Через несколько релизов, когда ТОЧНО нигде уже колонка НЕ используется - её
можно удалить, НО переименование - ЗЛО, забудь о нём!
 - Всегда создавай миграции с учётом отката для каждой таблицы, т.е. унарно
 - alembic НЕ хранит данные сущностей, а только версии схем, поэтому данные можно
похерить
 - mixins нужны для добавления общих колонок для таблиц, в отличие от Base,
может быть не на всех таблицах
 - В alembic.ini можно настроить адекватное именование ревизий через `file_template`

## Работа с alembic:
1. Инициализация alembic
```shell
alembic init alembic
```
2. Подсовываем наш конфиг в alembic.env:
`config.set_main_option("sqlalchemy.url", DB_URL)`
Т.е. по факту перезаписываем `sqlalchemy.url` в файле alembic.ini
3. Создаём в ручную новую ревизию:
```shell
alembic revision -m "create account table"
```

В файлах директории versions, есть два метода: `upgrade` и `downgrade`,
первый обновляет состояние БД, второй возвращает БД к предыдущему состоянию,
по факту это rollback

В каждой ревизии должны быть корректно прописаны оба метода, для возможности отката.

4. Импортируем Base в alembic.env и подставляем в target_metadata:
`Base.metadata`

5. Создаём автоматически ревизию (в vertions появится ревизия, проверяем!):
```shell
alembic revision --autogenerate -m "create users table"
```

7. Выполняем миграцию последней ревизии
```shell
alembic upgrade head
```

8. Откатываемся к предыдущей ревизии: `alembic downgrade -1`

9. Откат в самое начало: `alembic downgrade base`, а
`alembic upgrade head` снова вернёт нас к последнему состоянию

10. Проверка истории ревизий в адекватном порядке `alembic history`
и проверяем на какой ревизии сейчас находимся `alembic current`

### Офлайн миграции
Бывают дни, когда нет возможности подключиться к БД и нужно подготовить SQL
для обновления или отката (upgrade|downgrade):
`alembic upgrade --sql 7ad3:fa572`

[//]: # (revision = "fa572fa8023c")
[//]: # (down_revision = "7ad378002ee7")













